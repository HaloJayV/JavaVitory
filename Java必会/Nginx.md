[TOC]

### 基本介绍

Nginx是一个http服务器。是一个使用c语言开发的高性能的http 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。nginx能够支撑5万并发链接，并且cpu、内存等资源消耗却非常低，运行非常稳定，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等



#### Nginx有两类进程，一类称为Master进程(相当于管理进程)，另一类称为Worker进程（实际工作进程）。启动方式有两种：

（1）单进程启动：此时系统中仅有一个进程，该进程既充当Master进程的角色，也充当Worker进程的角色。

（2）多进程启动：此时系统有且仅有一个Master进程，至少有一个Worker进程工作。

（3）Master进程主要进行一些全局性的初始化工作和管理Worker的工作；事件处理是在Worker中进行的。

1、单进程多线程模型：MySQL、Memcached、Oracle（Windows版本）；

2、多进程模型：Oracle（Linux版本）；

![image-20201024194518942](C:\Users\qq285\AppData\Roaming\Typora\typora-user-images\image-20201024194518942.png)

### Nginx的应用场景

 1）反向代理：反向代理（ReverseProxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端,  简单来说就是真实的服务器不能直接被外部网络访问,想要访问必须通过代理。正向代理代理的是客户端；反向代理代理的是服务器

通俗来讲，客户端发送请求给反向代理服务器，但是代理服务器上没有客户端需要的资源，代理服务器会判断转发到原始服务器获得资源，并把资源返回给客户端；在整个过程，客户端不知道自己访问的是一个代理服务器，而是一个原始服务器

 2）动静分离：运用Nginx的反向代理功能分发请求：所有动态资源的请求交给应用服务器，而静态资源的请求（例如图片、视频、CSS、JavaScript文件等）则直接由Nginx返回到浏览器，这样能大大减轻应用服务器的压力

 3）负载均衡：负载均衡也是 Nginx常用的一个功能，当一台服务器的单位时间内的访问量越大时，服务器压力就越大，大到超过自身承受能力时，服务器就会崩溃。为了避免服务器崩溃，让用户有更好的体验，我们通过负载均衡的方式来分担服务器压力。我们可以建立很多很多服务器，组成一个服务器集群，当用户访问网站时，先访问一个中间服务器，在让这个中间服务器在服务器集群中选择一个压力较小的服务器，然后将该访问请求引入该服务器。如此以来，用户的每次访问，都会保证服务器集群中的每个服务器压力趋于平衡，分担了服务器压力，避免了服务器崩溃的情况。负载均衡配置一般都需要同时配置反向代理，通过反向代理跳转到负载均衡。



### Nginx反向代理

# Nginx如何做负载均衡

### 1.一致性哈希

* ##### 和HashMap的key类似，去做一个一致性哈希，使得能比较均衡地放在各个机器上

* 相对于简单哈希的劣势：当机器数量发生变动的时候，几乎所有的数据都会移动，这个代价很大。

一致性哈希就为了解决这种问题：当增加或者删除节点时，对于大多数记录，保证原来分配到的某个节点，现在仍然应该分配到那个节点，将数据迁移量的降到最低

* 一致性 Hash 算法也是使用取模的思想，只是，刚才描述的取模法是对节点数量进行取模，而一致性Hash算法是对 `2^32` 取模，什么意思呢？简单来说，一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希环如下，从 0 ~ 2^32-1 代表的分别是一个个的节点,这个环也叫哈希环。然后我们将我们的节点进行一次哈希，按照一定的规则，比如按照 ip 地址的哈希值，让节点落在哈希环上。比如此时我们可能得到了如下图的环:![img](../../../../Software/Typora/Picture/9463862-e786b08fc6b0d7fd.png)

*  然后就是需要通过数据 key 找到对应的服务器然后存储了，我们约定,通过数据 key 的哈希值落在哈希环上的节点，如果命中了机器节点就落在这个机器上，否则落在顺时针直到碰到第一个机器。如下图所示 : A 的哈希值落在了 D2 节点的前面，往下找落在了 D2 机器上，D的哈希值 在 D1 节点的前面，往下找到了 D1 机器，B的哈希值刚好落在了D1 节点上，依次循环![img](../../../../Software/Typora/Picture/9463862-210f9b16052620ec.png)

  

* ##### 2.2 一致性哈希的分析

  一致性哈希主要就是解决当机器减少或增加的时候，大面积的数据重新哈希的问题，主要从下面 2 个方向去考虑的，当节点宕机时，数据记录会被定位到下一个节点上，当新增节点的时候 ，相关区间内的数据记录就需要重新哈希。

  

### 2.加权哈希

根据机器的性能，可以给性能好的机器加权重，

### 3. 轮询

轮流

# 负载均衡算法

### 1.round robin（默认）

轮询方式，依次将请求分配到各个后台服务器中，默认的负载均衡方式。 
适用于后台机器性能一致的情况。 
挂掉的机器可以自动从服务列表中剔除。

### 2.weight

根据权重来分发请求到不同的机器中，指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。  

```
upstream bakend {    
    server 192.168.0.14 weight=10;    
    server 192.168.0.15 weight=10;    
}  
```

### 3. IP_hash

根据请求者ip的hash值取模处理后，将请求发送到后台服务器中，可以保证来自同一ip的请求被打到固定的机器上，可以解决session问题。

```
upstream bakend {    
    ip_hash;    
    server 192.168.0.14:88;    
    server 192.168.0.15:80;    
}   
```

### 4.url_hash（第三方）

根据请求的url的hash值取模处理后，将请求分到不同的机器中，当后台服务器为缓存的时候效率高。

在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法 

```
upstream backend {    
    server squid1:3128;    
    server squid2:3128;    
    hash $request_uri;    
    hash_method crc32;    
}  
```

tips: 

```
upstream bakend{#定义负载均衡设备的Ip及设备状态    
    ip_hash;    
    server 127.0.0.1:9090 down;    
    server 127.0.0.1:8080 weight=2;    
    server 127.0.0.1:6060;    
    server 127.0.0.1:7070 backup;    
} 
```

在需要使用负载均衡的server中增加 

```
proxy_pass http://bakend/; 
```

每个设备的状态设置为: 

1.down：表示单前的server暂时不参与负载 
2.weight：默认为1.weight越大，负载的权重就越大。 
3.max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误 
4.fail_timeout：max_fails次失败后，暂停的时间。 
5.backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。 

> nginx支持同时设置多组的负载均衡，用来给不用的server来使用。 
> client_body_in_file_only 设置为On 可以讲client post过来的数据记录到文件中用来做debug 
> client_body_temp_path 设置记录文件的目录 可以设置最多3层目录 
> location 对URL进行匹配.可以进行重定向或者进行新的代理 负载均衡

### 5. fair（第三方）

根据后台响应时间来分发请求，响应时间短的分发的请求多。

```
upstream backend {    
server server1;    
server server2;    
fair;    
}  
```

### 基本配置代理

```
server {
    listen       80;
    server_name  gulimall.com;

    #charset koi8-r;
    #access_log  /var/log/nginx/log/host.access.log  main;

    location / {
        proxy_pass http://192.168.19.1:10010;
    }
```



### upstream配置

nginx.conf 的上流配置

```
    upstream gulimall{
        server 192.168.200.1:88;
    }
```

conf.d/gulimall.conf  反向代理配置

坑：nginx代理给网关的时候会丢失请求的host信息、cookie等信息，需要加上proxy_set_header Host $host

```
server {
    listen       80;
    server_name  gulimall.com;

    #charset koi8-r;
    #access_log  /var/log/nginx/log/host.access.log  main;

    location / {
    	proxy_set_header Host $host;
        proxy_pass http://gulimall;
    }       
}
```



# 面试

## nginx正向代理和反向代理区别

区别是哪种代理主要是相对于客户端而言

##### 正向代理

如科学上网（自己搭建的可以翻墙的代理服务器），影藏了客户端的信息，那么该代理服务器就是正向代理。即客户端请求正向代理服务器，服务器再转到互联网

"它代理的是客户端"，是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。

正向代理的用途：
（1）访问原来无法访问的资源，如Google
（2） 可以做缓存，加速访问资源
（3）对客户端访问授权，上网进行认证
（4）代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息

##### 反向代理

反向代理服务器能屏蔽内网服务器信息（防止内网被访问攻击），提供客户端负载均衡访问。主要用于搭建集群环境

"它代理的是服务端"，主要用于服务器集群分布式部署的情况下，反向代理隐藏了服务器的信息。

客户端是无感知代理的存在的，反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。因为客户端不需要任何配置就可以访问。

反向代理的作用：
（1）保证内网的安全，通常将反向代理作为公网访问地址，Web服务器是内网
（2）负载均衡，通过反向代理服务器来优化网站的负载











